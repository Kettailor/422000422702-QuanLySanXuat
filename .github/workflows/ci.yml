name: build-and-test

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - production-service
          - reporting-service
    defaults:
      run:
        working-directory: services/${{ matrix.service }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: production
          POSTGRES_USER: prod_admin
          POSTGRES_PASSWORD: prod_admin
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U prod_admin -d production"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mongo:
        image: mongo:6
        env:
          MONGO_INITDB_ROOT_USERNAME: mongo_admin
          MONGO_INITDB_ROOT_PASSWORD: mongo_admin
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --host localhost --port 27017 -u mongo_admin -p mongo_admin --authenticationDatabase admin --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      NODE_ENV: test
      SERVICE_NAME: ${{ matrix.service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure environment variables
        run: |
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "SERVICE_NAME=${{ matrix.service }}" >> $GITHUB_ENV
          if [ "${{ matrix.service }}" = "api-gateway" ]; then
            echo "GATEWAY_PORT=3000" >> $GITHUB_ENV
            echo "PRODUCTION_SERVICE_URL=http://localhost:4000" >> $GITHUB_ENV
            echo "REPORTING_SERVICE_URL=http://localhost:5000" >> $GITHUB_ENV
          elif [ "${{ matrix.service }}" = "production-service" ]; then
            echo "PORT=4000" >> $GITHUB_ENV
            echo "POSTGRES_HOST=postgres" >> $GITHUB_ENV
            echo "POSTGRES_PORT=5432" >> $GITHUB_ENV
            echo "POSTGRES_DB=production" >> $GITHUB_ENV
            echo "POSTGRES_USER=prod_admin" >> $GITHUB_ENV
            echo "POSTGRES_PASSWORD=prod_admin" >> $GITHUB_ENV
          elif [ "${{ matrix.service }}" = "reporting-service" ]; then
            echo "REPORTING_PORT=5000" >> $GITHUB_ENV
            echo "PRODUCTION_API_URL=http://production-service:4000" >> $GITHUB_ENV
            echo "MONGO_URI=mongodb://mongo_admin:mongo_admin@mongo:27017/reports?authSource=admin" >> $GITHUB_ENV
          fi

      - name: Install networking tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd

      - name: Wait for databases
        run: |
          timeout 120 bash -c 'until nc -z postgres 5432; do sleep 2; done'
          timeout 120 bash -c 'until nc -z mongo 27017; do sleep 2; done'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test
